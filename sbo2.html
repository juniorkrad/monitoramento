<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SBO-2</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <div id="toast-container"></div>

    <div class="page-container">
        <header class="header">
            <div class="logo-title-group">
                <img src="banner2.png" alt="Logo da Empresa">
                <h1>SBO-2</h1>
            </div>
            <nav class="header-nav">
                <span id="update-timestamp">Buscando dados...</span>
                <a href="index.html" class="nav-button">Home</a>
            </nav>
        </header>

        <div class="grid-container grid-2-cols">
            </div>
    </div>

    <footer class="footer">
        <p>© 2025 Painel de Monitoramento | Versão 1.0</p>
    </footer>

    <script>
        const API_KEY = 'AIzaSyA88uPhiRhU3JZwKYjA5B1rX7ndXpfka0I';
        const SHEET_ID = '1BDx0zd0UGzOr2qqg1nftfe5WLUMh6MkcFO5psAG5GtU';
        const RANGE = 'SBO2!A:C';
        
        const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const REFRESH_INTERVAL_SECONDS = 300;
        const container = document.querySelector('.grid-container');

        let currentProblems = new Set();
        function showToast(message, type = '') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('show'); }, 10);
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function createTableStructure() {
             for (let i = 1; i <= 2; i++) {
                const placaId = i.toString().padStart(2, '0');
                container.innerHTML += `<table><caption>PLACA ${placaId}</caption><thead><tr><th>Porta</th><th>Active</th><th>Inactive</th><th>Total</th><th>Status</th></tr></thead><tbody id="tbody-placa-${i}"></tbody></table>`;
            }
        }

        async function populateTables() {
            for (let i = 1; i <= 2; i++) {
                const tbody = document.getElementById(`tbody-placa-${i}`);
                if (tbody) { tbody.innerHTML = ''; }
            }
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro ao buscar dados da API: ${errorData.error.message}`);
                }
                const data = await response.json();
                
                const now = new Date();
                const timestampText = `Atualizado em: ${now.toLocaleDateString('pt-BR')} às ${now.toLocaleTimeString('pt-BR')}`;
                document.getElementById('update-timestamp').textContent = timestampText;

                const rows = data.values || []; 
                const dataRows = rows.slice(1);
                const portData = {};
                const newProblems = new Set();

                dataRows.forEach(columns => {
                    if (columns.length === 0) return;
                    const oltPort = columns[0]; // ex: "GPON1/16" da coluna A
                    const status = columns[2];  // ex: "Active" da coluna C
                    if (!oltPort || !status) return;

                    // --- INÍCIO DA CORREÇÃO ---
                    // Usa uma expressão regular para extrair os números do formato "GPON<placa>/<porta>"
                    const match = oltPort.match(/GPON(\d+)\/(\d+)/);
                    
                    // Se o formato não corresponder, pula esta linha
                    if (!match) return;

                    const placa = match[1]; // O primeiro número capturado (placa)
                    const porta = match[2]; // O segundo número capturado (porta)
                    // --- FIM DA CORREÇÃO ---
                    
                    const portKey = `${placa}/${porta}`;

                    if (!portData[portKey]) {
                        portData[portKey] = { active: 0, inactive: 0 };
                    }

                    if (status.trim().toLowerCase() === 'active') {
                        portData[portKey].active++;
                    } else if (status.trim().toLowerCase() === 'inactive') {
                        portData[portKey].inactive++;
                    }
                });

                for (const portKey in portData) {
                    const [placa, porta] = portKey.split('/');
                    const { active, inactive } = portData[portKey];
                    const total = active + inactive;
                    let statusClass = 'status-normal', statusText = 'Normal'; // Mudou para 'Normal'
                    if (inactive > 16) {
                        statusClass = 'status-problema';
                        statusText = 'Problema'; // Mudou para 'Problema'
                    } else if (inactive === 16) {
                         statusClass = 'status-atencao';
                         statusText = 'Atenção'; // Mudou para 'Atenção'
                    } else if (total > 0 && inactive / total >= 0.5) {
                        statusClass = 'status-problema';
                        statusText = 'Problema';
                    }
                    
                    if (statusClass === 'status-problema') {
                        newProblems.add(portKey);
                    }
                    const tableRowHTML = `<tr><td>Porta ${porta.padStart(2, '0')}</td><td>${active}</td><td>${inactive}</td><td>${total}</td><td><span class="status ${statusClass}">${statusText}</span></td></tr>`;
                    
                    const targetTbody = document.getElementById(`tbody-placa-${placa}`);
                    if (targetTbody) {
                        targetTbody.innerHTML += tableRowHTML;
                    }
                }

                for (const problemKey of newProblems) {
                    if (!currentProblems.has(problemKey)) {
                        const [placa, porta] = problemKey.split('/');
                        showToast(`Novo PROBLEMA detectado: PLACA ${placa.padStart(2, '0')} / PORTA ${porta.padStart(2, '0')}`, 'problem');
                    }
                }
                currentProblems = newProblems;

            } catch (error) {
                document.getElementById('update-timestamp').textContent = "Falha ao atualizar.";
                console.error('Falha na operação:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            createTableStructure();
            populateTables();
            setInterval(populateTables, REFRESH_INTERVAL_SECONDS * 1000);
        });
    </script>
    
</body>
</html>