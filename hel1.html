<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEL-1</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>

    <div id="toast-container"></div>

    <div class="page-container">
        <div id="header-placeholder"></div>

        <div class="grid-container grid-4-cols">
            </div>
    </div>

    <div id="footer-placeholder"></div>
    
    <script>
        const API_KEY = 'AIzaSyA88uPhiRhU3JZwKYjA5B1rX7ndXpfka0I';
        const SHEET_ID = '1BDx0zd0UGzOr2qqg1nftfe5WLUMh6MkcFO5psAG5GtU';
        const RANGE = 'HEL1!A:E'; 
        const API_URL = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const REFRESH_INTERVAL_SECONDS = 300;
        const container = document.querySelector('.grid-container');

        function createTableStructure() {
             for (let i = 1; i <= 8; i++) {
                const placaId = i.toString().padStart(2, '0');
                container.innerHTML += `<table><caption>PLACA ${placaId}</caption><thead><tr><th>Porta</th><th>UP</th><th>DOWN</th><th>Total</th><th>Status</th></tr></thead><tbody id="tbody-placa-${i}"></tbody></table>`;
            }
        }

        async function populateTables() {
            for (let i = 1; i <= 8; i++) {
                const tbody = document.getElementById(`tbody-placa-${i}`);
                if (tbody) {
                    tbody.innerHTML = '';
                }
            }
            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro ao buscar dados da API: ${errorData.error.message}`);
                }
                const data = await response.json();
                
                const rows = data.values || []; 
                const dataRows = rows.slice(1);
                const portData = {};
                const newProblems = new Set(); // Cria a lista de problemas para esta verificação

                dataRows.forEach(columns => {
                    if (columns.length === 0) return;
                    const pon = columns[0];
                    const status = columns[4];
                    if (!pon || !status) return;
                    const ponParts = pon.split('/');
                    if (ponParts.length < 4) return;
                    const placa = ponParts[2];
                    const porta = ponParts[3];
                    const portKey = `${placa}/${porta}`;
                    if (!portData[portKey]) {
                        portData[portKey] = { up: 0, down: 0 };
                    }
                    if (status.trim().toLowerCase().includes('up')) {
                        portData[portKey].up++;
                    } else {
                        portData[portKey].down++;
                    }
                });

                for (const portKey in portData) {
                    const [placa, porta] = portKey.split('/');
                    const { up, down } = portData[portKey];
                    const total = up + down;
                    let statusClass = 'status-normal', statusText = 'Normal';
                    if (total > 0 && (down / total === 1 || down / total === 0.5)) {
                        statusClass = 'status-problema';
                        statusText = 'Problema';
                    } else if (down >= 16) {
                        statusClass = 'status-atencao';
                        statusText = 'Atenção';
                    }
                    
                    // Adiciona a porta à lista de problemas, se for o caso
                    if (statusClass === 'status-problema') {
                        newProblems.add(portKey);
                    }
                    
                    const tableRowHTML = `<tr><td>Porta ${porta.padStart(2, '0')}</td><td>${up}</td><td>${down}</td><td>${total}</td><td><span class="status ${statusClass}">${statusText}</span></td></tr>`;
                    
                    const targetTbody = document.getElementById(`tbody-placa-${placa}`);
                    if (targetTbody) {
                        targetTbody.innerHTML += tableRowHTML;
                    }
                }

                // Chama a função centralizada do notifications.js para verificar e notificar
                checkAndNotifyForNewProblems(newProblems);

            } catch (error) {
                console.error('Falha na operação:', error);
            }
        }
    </script>
    
    <script src="layout.js"></script>
    <script src="notifications.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Carrega o layout
            loadHeader({
                title: "HEL-1",
                buttonText: "Home",
                buttonLink: "index.html"
            });
            loadFooter();
            
            // 2. Inicia a busca de dados da página
            createTableStructure();
            populateTables();
            setInterval(populateTables, REFRESH_INTERVAL_SECONDS * 1000);
        });
    </script>
</body>
</html>